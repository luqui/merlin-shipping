<html>
 <head>
  <title>Merlin's Herbal Magic Shipping Manager</title>
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>

  <style>
    tr.highlighted { background: #bfb }
    tr.pending     { background: #fa7 }
  </style>

  <script>

//var ip = '184.73.249.123:8080';
var ip = '127.0.0.1:8080';

function Request(cmd, arg, callback) {
    $.getJSON('http://' + ip + '/' + cmd + '?callback=?', arg, callback);
}

function Element(name, attrs) {
    var elt = $('<' + name + "/>", attrs);
    for (var i = 2; i < arguments.length; ++i) {
        elt.append(arguments[i]);
    }
    return elt;
}

function ShowBag(bag) {
    var ret = "";
    for (var i in bag) {
        ret += bag[i] + " " + i + ", ";
    }
    return ret;
}

function WithValue(value, elt)
{
    elt.val = function() { return value };
    return elt;
}

function TextInput() {
    return Element('input', { type: 'text' });
}

function TextOutput(val) {
    return WithValue(val, Element('span', { text: val }));
}

function TableVector(fields) {
    return function(val) {
        var table = Element('table', {});
        var eltable = {};
        for (var i in fields) {
            eltable[i] = fields[i](val[i]);
            table.append(Element('tr', {}, Element('td', { text: i }), Element('td', {}, eltable[i])));
        }

        table.val = function() {
            var ret = {};
            for (var i in fields) {
                var val = eltable[i].val();
                if (val != "") {
                    ret[i] = val;
                }
            }
            return ret;
        };

        return table;
    };
}

function CompactVector(val) {
    return WithValue(val, Element('span', { text: ShowBag(val) }));
}

function ConstInput(val) {
    return function() {
        var span = Element('span', {});
        span.val = function() { return val; };
        return span;
    };
}

function Field(field, ui) {
    return function (row) {
        var r = ui(row[field]);
        var elt = Element('span', {}, r);
        elt.val = function() {
            var rhash = {};
            rhash[field] = r.val();
            return rhash;
        };
        return elt;
    };
}

function ToggleShipped(row) {
    console.log(row);
    var button = Element('input', { type: 'button', value: row.shipped, click: function() {
        row.shipped = row.shipped == "Pending" ? "Shipped" : "Pending";
        Request('store', { row: row }, function(data) {
            button.val(row.shipped);
        });
    }});
    return button;
}

var orderInput = TableVector({ bags: TextInput, jars: TextInput, packs: TextInput, forks: TextInput });

var columns = [
    { header: 'Name',    input: Field('name',    TextInput),  output: Field('name', TextOutput) },
    { header: 'Address', input: Field('address', TextInput),  output: Field('address', TextOutput) },
    { header: 'Order',   input: Field('order',   orderInput), output: Field('order', CompactVector) },
    { header: 'Shipped', input: ConstInput({shipped: "Pending"}), output: ToggleShipped },
];

var protoRow = { name: '', address: '', order: { bags: '', jars: '', packs: '', forks: '' } };

function UID() {
    var result = '';
    for (var i = 0; i < 32; ++i) {
        result += Math.floor(Math.random()*16).toString(16);
    }
    return result;
}

function InputRow() {
    var elts = columns.map(function (i) { return i.input(protoRow) });

    var tr = Element('tr', { 'class': 'highlighted' });
    for (var i in elts) {
        tr.append(Element('td', {}, elts[i]));
    }
    tr.append(Element('td', {}, 
        Element('input', { type: 'button', click: function() {
            var row = { id: UID() };
            for (var i in columns) {
                $.extend(row, elts[i].val());
            }
            var p = tr.parent();
            tr.remove();
            var lit = LiteralRow(row);
            lit.addClass("pending");
            p.append(lit);
            p.append(InputRow());
            Request('store', { row: row }, function(data) {
                lit.removeClass("pending");
            });
        }})));
    
    return tr;                   
}

function LiteralRow(row) {
    var tr = Element('tr');
    for (var i in columns) {
        tr.append(Element('td', {}, columns[i].output(row)));
    }
    return tr;
}

function MakeTable() {
    var headtr = Element('tr', {});
    for (var i in columns) {
        headtr.append(Element('td', { text: columns[i].header }));
    }
    return Element('table', {}, Element('thead', {}, headtr), Element('tbody', {}));
}

$(function() {
    var loading = Element('span', { text: 'Loading database' });
    $('#content').append(loading);
    Request('dump', {}, function(db) {
        loading.remove();
        var table = MakeTable();
        $('#content').append(table);
        for (var i in db) {
            table.append(LiteralRow(db[i]));
        }
        table.append(InputRow());
    });
});

  </script>
 </head>
 <body>
  <div id="content">
  </div>
 </body>
</html>
