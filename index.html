<html>
 <head>
  <title>Merlin's Herbal Magic Shipping Manager</title>

  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>

  <style>
    table {
        border-collapse: collapse;
    }
    td {
        border: 1px solid black;
        padding: 3px;
    }
    thead {
        background: lightblue;
        font-weight: bold;
    }
    tr.highlighted { background: #bfb }
    .pending     { background: #fa7 }
    tr.unsubmitted { background: gray }
    textarea { height: 12ex; width: 100% }
    a { text-decoration: none }
    a:hover { text-decoration: underline }
  </style>

  <script>

//var ip = '184.73.249.123:8080';
var ip = '127.0.0.1:8080';

function Request(cmd, arg, callback) {
    $.getJSON('http://' + ip + '/' + cmd + '?callback=?', arg, callback);
}

function Element(name, attrs) {
    var elt = $('<' + name + "/>", attrs);
    for (var i = 2; i < arguments.length; ++i) {
        elt.append(arguments[i]);
    }
    return elt;
}

function ShowBag(bag) {
    var ret = "";
    for (var i in bag) {
        ret += bag[i] + " " + i + ", ";
    }
    return ret;
}

function WithValue(value, elt)
{
    elt.val = function() { return value };
    return elt;
}

function TextInput(val) {
    return Element('input', { type: 'text', value: val });
}

function SizedTextInput(size) {
    return function(val) {
        return Element('input', { type: 'text', value: val, size: size });
    };
}

function TextOutput(val) {
    return WithValue(val, Element('span', { text: val }));
}

function MultilineTextOutput(val) {
    if (!val) val = "";
    return WithValue(val, Element('span', { html: val.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g,"<br/>") }));
}

function TableVector(fields) {
    return function(val) {
        var table = Element('table', {});
        var eltable = {};
        for (var i in fields) {
            eltable[i] = fields[i](val[i]);
            table.append(Element('tr', {}, Element('td', { text: i }), Element('td', {}, eltable[i])));
        }

        table.val = function() {
            var ret = {};
            for (var i in fields) {
                var val = eltable[i].val();
                if (val != "") {
                    ret[i] = val;
                }
            }
            return ret;
        };

        return table;
    };
}

function CompactVector(val) {
    return WithValue(val, Element('span', { text: ShowBag(val) }));
}

function ConstInput(val) {
    return function() {
        var span = Element('span', {});
        span.val = function() { return val; };
        return span;
    };
}

function Field(field, ui) {
    return function (row) {
        var r = ui(row[field]);
        var elt = Element('span', {}, r);
        elt.val = function() {
            var rhash = {};
            rhash[field] = r.val();
            return rhash;
        };
        return elt;
    };
}

function FormatDate(d) {
    return (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear();
}

function SetButton(button, row) {
    button.val(row.shipped);
    if (row.shipped != "Pending") button.removeClass("pending") 
    else button.addClass("pending");
}

function ToggleShipped(row) {
    var button = Element('input', { type: 'button', click: function() {
        row.shipped = row.shipped == "Pending" ? "Shipped " + FormatDate(new Date()) : "Pending";
        Request('store', { row: row }, function(data) {
            SetButton(button, row);
        });
    }});
    SetButton(button, row);
    return button;
}

function TextAreaInput(text) {
    return Element('textarea', { text: text });
}

var orderInput = function () {
    var inp = SizedTextInput(3);
    return TableVector({ bags: inp, jars: inp, packs: inp, forks: inp });
}();
var addressInput = TableVector({ address: TextInput, city: TextInput, state: TextInput, zip: TextInput });
var addressOutput = function(row) { 
    var addr = row.address;
    var out = MultilineTextOutput(addr.address + "\n" + addr.city + ", " + addr.state + " " + addr.zip);
    var enc = encodeURIComponent;
    var url = "https://sss-web.usps.com/cns/labelInformationView.do" 
            + "?deliveryFullName=" + enc(row.name)
            + "&deliveryAddressOne=" + enc(addr.address)
            + "&deliveryCity=" + enc(addr.city)
            + "&deliveryState=" + enc(addr.state)
            + "&deliveryZipcode=" + enc(addr.zip)
            + "&deliveryRefNbr=" + enc(row.id);
    return WithValue(out.val(), Element("a", { href: url, target: "_blank" }, out));
};

var columns = [
    { header: 'Name',    input: Field('name',    TextInput),  output: Field('name', TextOutput) },
    { header: 'Address', input: Field('address', addressInput), output: addressOutput },
    { header: 'Order',   input: Field('order',   orderInput), output: Field('order', CompactVector) },
    { header: 'Status',  input: ConstInput({shipped: "Pending"}), output: ToggleShipped },
    { header: 'Notes',   input: Field('notes', TextAreaInput), output: Field('notes', MultilineTextOutput) },
];

var protoRow = { name: '', address: '', order: { bags: '', jars: '', packs: '', forks: '' } };

function UID() {
    var result = '';
    for (var i = 0; i < 10; ++i) {
        result += Math.floor(Math.random()*16).toString(16);
    }
    return result;
}

function InputRow(row) {
    if (!row) { row = protoRow }
    var elts = columns.map(function (i) { return i.input(row) });

    var tr = Element('tr', { 'class': 'highlighted' });
    for (var i in elts) {
        tr.append(Element('td', {}, elts[i]));
    }
    tr.append(Element('td', {}, 
        Element('input', { type: 'button', click: function() {
            var row = { id: UID() };
            for (var i in columns) {
                $.extend(row, elts[i].val());
            }
            var p = tr.parent();
            tr.remove();
            var lit = LiteralRow(row);
            lit.addClass("unsubmitted");
            p.append(lit);
            p.append(InputRow());
            Request('store', { row: row }, function(data) {
                lit.removeClass("unsubmitted");
            });
        }})));
    
    return tr;                   
}

function LiteralRow(row) {
    var tr = Element('tr');
    for (var i in columns) {
        tr.append(Element('td', {}, columns[i].output(row)));
    }
    return tr;
}

function MakeTable() {
    var headtr = Element('tr', {});
    for (var i in columns) {
        headtr.append(Element('td', { text: columns[i].header }));
    }
    return Element('table', {}, Element('thead', {}, headtr), Element('tbody', {}));
}

$(function() {
    var loading = Element('span', { text: 'Loading database' });
    var currentInputRow;
    var table;

    $('#content').append(loading);
    Request('dump', {}, function(db) {
        loading.remove();
        table = MakeTable();
        $('#content').append(table);
        for (var i in db) {
            table.append(LiteralRow(db[i]));
        }
        currentInputRow = InputRow();
        table.append(currentInputRow);
    });

    $('#fetch_transaction').click(function () {
        var tid = $('#transaction_id').val().replace(/^\s*/,'').replace(/\s*$/,'');
        Request('get_paypal_transaction', { transaction_id: tid }, function (transaction) {
            if (transaction.ACK == "Success") {
                $('#paypal_status').text('');
                if (currentInputRow) { currentInputRow.remove(); }
                currentInputRow = InputRow($.extend({}, protoRow, { 
                    name: transaction.SHIPTONAME, 
                    address: { address: transaction.SHIPTOSTREET, city: transaction.SHIPTOCITY, state: transaction.SHIPTOSTATE, zip: transaction.SHIPTOZIP },
                }));
                table.append(currentInputRow);
            }
            else {
                $('#paypal_status').text(transaction.L_LONGMESSAGE0);
            }
        });
    });
});

  </script>
 </head>
 <body>
  <div id="content">
  </div>
  <p><b>From PayPal transaction ID:</b><input type="text" id="transaction_id" /><input type="button" id="fetch_transaction" value="Go fetch!" /></p>
  <p style="color: red" id="paypal_status"></p>
 </body>
</html>
